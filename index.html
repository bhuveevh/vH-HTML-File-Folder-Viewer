<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>vH-HTML Tool Viewer with Code Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .resize-row { resize: vertical; overflow: auto; min-height: 50px; }
    #editor-html, #editor-css, #editor-js { min-height: 100px; }
    .resizable-pane { display: flex; overflow: hidden; }
    .resizable-left {
      width: 33%;
      min-width: 150px;
      resize: horizontal;
      overflow: hidden;
      background: #1e1e1e;
      color: white;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .resizable-right { flex: 1; overflow: auto; }
    .editor-container {
      border: 1px solid #4b5563;
      border-radius: 4px;
      margin-bottom: 8px;
      padding: 4px;
      flex-shrink: 0;
      position: relative;
      background: #232323;
    }
    .floating-run-btn {
      position: fixed;
      left: 38px;
      bottom: 38px;
      z-index: 9999;
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 50%;
      box-shadow: 0 4px 16px 0 rgba(34,197,94,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s;
      cursor: pointer;
      border: 4px solid #fff;
      outline: none;
    }
    .floating-run-btn:hover {
      background: linear-gradient(135deg, #16a34a, #22c55e);
      box-shadow: 0 8px 24px 0 rgba(22,163,74,0.4);
    }
    .floating-run-btn svg {
      width: 2.2em;
      height: 2.2em;
      color: #fff;
      margin-left: 4px;
      margin-top: 2px;
    }
    .floating-run-btn-tooltip {
      position: absolute;
      left: 80px;
      bottom: 16px;
      background: #232323;
      color: #fff;
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 1rem;
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.15);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.17s;
    }
    .floating-run-btn:hover .floating-run-btn-tooltip {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 600px) {
      .floating-run-btn {
        left: 12px;
        bottom: 12px;
        width: 54px;
        height: 54px;
      }
      .floating-run-btn-tooltip {
        left: 70px;
        font-size: 0.97rem;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs/loader.js"></script>
  <script>
    let fileMap = new Map();
    let editorHTML, editorCSS, editorJS;

    function handleFiles(files, isSingle = false) {
      fileMap.clear();
      for (const file of files) {
        const key = file.webkitRelativePath || file.name;
        fileMap.set(key, file);
      }
      const container = document.getElementById('fileTree');
      container.innerHTML = '';
      if (!isSingle) {
        const tree = {};
        for (const path of fileMap.keys()) {
          const parts = path.split('/');
          let current = tree;
          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (!current[part]) {
              current[part] = i === parts.length - 1 ? null : {};
            }
            current = current[part] || {};
          }
        }
        buildHorizontalMindmap(tree);
      } else {
        container.innerHTML = `<p class="text-gray-700 text-sm">üìÑ ${[...fileMap.keys()][0]}</p>`;
      }
    }

    // Horizontal mindmap (left to right, auto width, no overflow)
    function buildHorizontalMindmap(tree, containerId = 'fileTree') {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      // Find root and children
      const rootName = Object.keys(tree)[0] || "Root";
      const root = tree[rootName] || {};
      const children = Object.entries(root);

      // SVG font settings
      const fontFamily = "Inter, Arial, sans-serif";
      const fontSize = 18; // px

      // --- 1. Measure all node label widths (including icons) ---
      // We'll use a hidden SVG text element for real measurement
      const measurer = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      measurer.style.visibility = "hidden";
      document.body.appendChild(measurer);

      function measureText(text, fontSizePx = fontSize, fontFam = fontFamily) {
        const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
        t.setAttribute("font-size", fontSizePx + "px");
        t.setAttribute("font-family", fontFam);
        t.textContent = text;
        measurer.appendChild(t);
        const width = t.getBBox().width;
        measurer.removeChild(t);
        return width;
      }

      // central node
      const centralLabelWidth = Math.ceil(measureText(rootName, 24, fontFamily)) + 40; // +padding

      // child nodes
      const nodeHeights = [];
      let maxNodeLabelW = 0;
      const childNodeWidths = children.map(([name]) => {
        const w = Math.ceil(measureText(name, fontSize, fontFamily));
        maxNodeLabelW = Math.max(maxNodeLabelW, w);
        nodeHeights.push(46);
        return w;
      });

      document.body.removeChild(measurer);

      const nodeHeight = 46;
      const nodeYPad = 12;
      const branchLength = 160;
      // Calculate SVG width & height based on children
      const svgWidth = centralLabelWidth/2 + branchLength + maxNodeLabelW + 70 + 40;
      const svgHeight = Math.max(220, children.length * (nodeHeight + nodeYPad));

      // Center points
      const centerX = 40 + centralLabelWidth/2;
      const centerY = svgHeight / 2;

      // SVG base
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", svgWidth);
      svg.setAttribute("height", svgHeight);
      svg.style.display = "block";
      svg.style.margin = "0 auto";

      // Central node (root)
      const centralGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
      const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
      rect.setAttribute("x", centerX - centralLabelWidth/2);
      rect.setAttribute("y", centerY - nodeHeight/2);
      rect.setAttribute("rx", 16);
      rect.setAttribute("ry", 16);
      rect.setAttribute("width", centralLabelWidth);
      rect.setAttribute("height", nodeHeight);
      rect.setAttribute("fill", "#fff");
      rect.setAttribute("stroke", "#888");
      rect.setAttribute("stroke-width", "2");
      centralGroup.appendChild(rect);
      const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
      text.setAttribute("x", centerX);
      text.setAttribute("y", centerY + 7);
      text.setAttribute("text-anchor", "middle");
      text.setAttribute("font-size", "1.5em");
      text.setAttribute("font-weight", "bold");
      text.setAttribute("font-family", fontFamily);
      text.textContent = rootName;
      centralGroup.appendChild(text);
      svg.appendChild(centralGroup);

      // If no children, done
      if (!children.length) {
        container.appendChild(svg);
        return;
      }

      // Spread children vertically
      const totalHeight = (children.length - 1) * (nodeHeight + nodeYPad);
      const startY = centerY - totalHeight / 2;

      const branchColors = [
        "#60c020", "#55c4e7", "#347cf7", "#fbc02d", "#f87171", "#a78bfa", "#f59e42", "#a3e635"
      ];

      children.forEach(([name, sub], i) => {
        // Node position
        const y = startY + i * (nodeHeight + nodeYPad);

        // Use measured width for this label
        const measuredLabelW = childNodeWidths[i];
        const nodeLabelW = 46 + measuredLabelW + 18; // icon + gap + text + some padding

        // Points
        const fromX = centerX + centralLabelWidth/2;
        const fromY = centerY;
        const toX = fromX + branchLength;
        const toY = y + nodeHeight/2;

        // Bezier curve for branch
        const ctrlX = fromX + branchLength/2;
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d",
          `M${fromX},${fromY} C${ctrlX},${fromY} ${ctrlX},${toY} ${toX},${toY}`
        );
        path.setAttribute("stroke", branchColors[i % branchColors.length]);
        path.setAttribute("stroke-width", 7);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke-linecap", "round");
        svg.appendChild(path);

        // Node group (file/folder)
        const nodeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        nodeGroup.setAttribute("transform", `translate(${toX},${toY - nodeHeight/2})`);

        // Node rect
        const nodeRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        nodeRect.setAttribute("x", 0);
        nodeRect.setAttribute("y", 0);
        nodeRect.setAttribute("rx", 11);
        nodeRect.setAttribute("ry", 11);
        nodeRect.setAttribute("width", nodeLabelW);
        nodeRect.setAttribute("height", nodeHeight);
        nodeRect.setAttribute("fill", "#fff");
        nodeRect.setAttribute("stroke", "#bbb");
        nodeRect.setAttribute("stroke-width", "1.5");
        nodeGroup.appendChild(nodeRect);

        // Icon
        const icon = document.createElementNS("http://www.w3.org/2000/svg", "text");
        icon.setAttribute("x", 17);
        icon.setAttribute("y", nodeHeight/2 + 7);
        icon.setAttribute("font-size", "1.3em");
        icon.setAttribute("font-family", "Segoe UI Emoji");
        icon.textContent = sub === null ? "üìÑ" : "üìÅ";
        nodeGroup.appendChild(icon);

        // Label
        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("x", 40);
        label.setAttribute("y", nodeHeight/2 + 7);
        label.setAttribute("font-size", fontSize + "px");
        label.setAttribute("font-family", fontFamily);
        label.setAttribute("fill", "#444");
        label.textContent = name;
        nodeGroup.appendChild(label);

        svg.appendChild(nodeGroup);
      });

      container.appendChild(svg);

      // Responsive parent box
      container.style.overflowX = "auto";
      container.style.justifyContent = "flex-start";
      container.style.alignItems = "center";
      container.style.minWidth = "0";
      container.style.maxWidth = "100%";
      svg.style.minWidth = "0";
      svg.style.maxWidth = "none";
    }

    async function openHTML() {
      const htmlFile = [...fileMap.values()].find(f => f.name.endsWith('.html'));
      if (!htmlFile) return alert('No HTML file found!');
      const htmlText = await htmlFile.text();
      renderHTMLContent(htmlText);
    }

    function renderHTMLContent(htmlText) {
      const blob = new Blob([htmlText], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      document.getElementById('popupFrame').src = url;
      document.getElementById('popupModal').classList.remove('hidden');
    }

    function closePopup() {
      document.getElementById('popupModal').classList.add('hidden');
      document.getElementById('popupFrame').src = '';
    }

    function openToolPreview() {
      document.getElementById('toolPreviewModal').classList.remove('hidden');
    }

    function closeToolPreview() {
      document.getElementById('toolPreviewModal').classList.add('hidden');
    }

    function runCustomCode() {
      const html = editorHTML.getValue();
      const css = `<style>${editorCSS.getValue()}</style>`;
      const js = `<script>${editorJS.getValue()}<\/script>`;
      const result = html + css + js;
      const blob = new Blob([result], { type: 'text/html' });
      document.getElementById('toolPreviewFrame').src = URL.createObjectURL(blob);
    }

    function autoUpdatePreview() {
      runCustomCode();
    }

    // ---- Monaco Editor Loader ----
    window.onload = () => {
      require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.38.0/min/vs' }});
      require(['vs/editor/editor.main'], () => {
        monaco.languages.registerColorProvider('html', {
          provideDocumentColors: function(model) {
            const colorRegex = /(#(?:[0-9a-fA-F]{3,8}))|\b(?:rgb|rgba|hsl|hsla)\([^\)]*\)|\b(aliceblue|antiquewhite|aqua|aquamarine|azure|beige|bisque|black|blanchedalmond|blue|blueviolet|brown|burlywood|cadetblue|chartreuse|chocolate|coral|cornflowerblue|cornsilk|crimson|cyan|darkblue|darkcyan|darkgoldenrod|darkgray|darkgreen|darkgrey|darkkhaki|darkmagenta|darkolivegreen|darkorange|darkorchid|darkred|darksalmon|darkseagreen|darkslateblue|darkslategray|darkslategrey|darkturquoise|darkviolet|deeppink|deepskyblue|dimgray|dimgrey|dodgerblue|firebrick|floralwhite|forestgreen|fuchsia|gainsboro|ghostwhite|gold|goldenrod|gray|green|greenyellow|grey|honeydew|hotpink|indianred|indigo|ivory|khaki|lavender|lavenderblush|lawngreen|lemonchiffon|lightblue|lightcoral|lightcyan|lightgoldenrodyellow|lightgray|lightgreen|lightgrey|lightpink|lightsalmon|lightseagreen|lightskyblue|lightslategray|lightslategrey|lightsteelblue|lightyellow|lime|limegreen|linen|magenta|maroon|mediumaquamarine|mediumblue|mediumorchid|mediumpurple|mediumseagreen|mediumslateblue|mediumspringgreen|mediumturquoise|mediumvioletred|midnightblue|mintcream|mistyrose|moccasin|navajowhite|navy|oldlace|olive|olivedrab|orange|orangered|orchid|palegoldenrod|palegreen|paleturquoise|palevioletred|papayawhip|peachpuff|peru|pink|plum|powderblue|purple|rebeccapurple|red|rosybrown|royalblue|saddlebrown|salmon|sandybrown|seagreen|seashell|sienna|silver|skyblue|slateblue|slategray|slategrey|snow|springgreen|steelblue|tan|teal|thistle|tomato|turquoise|violet|wheat|white|whitesmoke|yellow|yellowgreen)\b/gi;
            const colors = [];
            const lines = model.getLinesContent();
            for (let i = 0; i < lines.length; i++) {
              let match;
              while ((match = colorRegex.exec(lines[i])) !== null) {
                const start = match.index + 1;
                const end = start + match[0].length;
                let color = parseCssColor(match[0]);
                if (color) {
                  colors.push({
                    color,
                    range: new monaco.Range(i + 1, start, i + 1, end)
                  });
                }
              }
            }
            return colors;
          },
          provideColorPresentations: function(model, colorInfo) {
            const rgba = colorInfo.color;
            let r = Math.round(rgba.red * 255);
            let g = Math.round(rgba.green * 255);
            let b = Math.round(rgba.blue * 255);
            let a = rgba.alpha;
            let hex = "#" + [r,g,b].map(x => x.toString(16).padStart(2, '0')).join('');
            if (a < 1) hex += Math.round(a * 255).toString(16).padStart(2, '0');
            return [{ label: hex }];
          }
        });

        editorHTML = monaco.editor.create(document.getElementById('editor-html'), {
          value: '<!-- HTML here -->',
          language: 'html',
          theme: 'vs-dark',
          automaticLayout: true
        });
        editorCSS = monaco.editor.create(document.getElementById('editor-css'), {
          value: '/* CSS here */',
          language: 'css',
          theme: 'vs-dark',
          automaticLayout: true
        });
        editorJS = monaco.editor.create(document.getElementById('editor-js'), {
          value: '// JS here',
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true
        });

        [editorHTML, editorCSS, editorJS].forEach(editor => {
          editor.onDidChangeModelContent(() => {
            autoUpdatePreview();
          });
        });

        autoUpdatePreview();
      });

      function parseCssColor(str) {
        const canvas = document.createElement('canvas');
        canvas.width = canvas.height = 1;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,1,1);
        ctx.fillStyle = str;
        ctx.fillRect(0,0,1,1);
        const data = ctx.getImageData(0,0,1,1).data;
        if (data[3] === 0) return null;
        return {
          red: data[0]/255,
          green: data[1]/255,
          blue: data[2]/255,
          alpha: data[3]/255
        };
      }
    };
  </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-4xl flex flex-col">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">üìÅ vH-HTML Viewer Tool/Code Editor</h1>

    <!-- Two column input widget -->
    <div class="flex flex-col gap-4 mb-4">
      <div class="flex flex-row gap-4">
        <div class="flex-1 bg-gray-50 border rounded-lg p-4 flex flex-col items-center">
          <div class="font-semibold text-gray-700 mb-2">Folder Input</div>
          <input type="file" webkitdirectory multiple onchange="handleFiles(this.files, false)"
            class="border p-2 rounded w-full">
        </div>
        <div class="flex-1 bg-gray-50 border rounded-lg p-4 flex flex-col items-center">
          <div class="font-semibold text-gray-700 mb-2">HTML File Input</div>
          <input type="file" accept=".html" onchange="handleFiles(this.files, true)"
            class="border p-2 rounded w-full">
        </div>
      </div>
      <!-- Mindmap area -->
      <div id="fileTree" class="bg-gray-50 border p-4 rounded overflow-auto max-h-96 text-sm flex justify-start items-center min-h-[220px]">
        <p class="text-gray-500">üìÅ Folder structure or file name will appear here...</p>
      </div>
    </div>

    <button onclick="openHTML()"
      class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded mb-4">
      üîç Open Local HTML in Popup
    </button>
    <!-- Tool Preview Button at bottom -->
    <button onclick="openToolPreview()"
      class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded mt-8">
      üõ† Tool Preview
    </button>

    <!-- Branding at the bottom -->
    <div class="text-center text-xs text-gray-500 mt-6">
      Developed by
      <a href="https://vacancyhai.online" target="_blank" class="hover:underline font-semibold text-blue-600">
        VACANCYHAI.ONLINE
      </a>
      | Inspired by USERS
    </div>
  </div>

  <div id="popupModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg overflow-hidden w-full max-w-5xl h-[90%] shadow-lg relative">
      <button onclick="closePopup()"
        class="absolute top-3 right-3 w-10 h-10 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white rounded-full shadow-md text-xl transition">
        &times;
      </button>
      <iframe id="popupFrame" class="w-full h-full border-0"></iframe>
    </div>
  </div>

  <div id="toolPreviewModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden">
    <div class="flex flex-col w-full h-full">
      <div class="flex-none p-2 text-white bg-gray-900 flex justify-between items-center">
        <span class="text-lg font-semibold">üõ† Tool Preview</span>
        <button onclick="closeToolPreview()"
          class="w-10 h-10 flex items-center justify-center bg-red-600 hover:bg-red-700 text-white rounded-full">
          &times;
        </button>
      </div>
      <div class="flex-1 resizable-pane relative">
        <div class="resizable-left p-2 overflow-y-auto">
          <div class="editor-container">
            <div class="text-sm font-bold mb-1">HTML</div>
            <div id="editor-html" class="resize-row" style="height: 150px;"></div>
          </div>
          <div class="editor-container">
            <div class="text-sm font-bold mb-1">CSS</div>
            <div id="editor-css" class="resize-row" style="height: 120px;"></div>
          </div>
          <div class="editor-container">
            <div class="text-sm font-bold mb-1">JS</div>
            <div id="editor-js" class="resize-row" style="height: 120px;"></div>
          </div>
        </div>
        <div class="resizable-right bg-white">
          <iframe id="toolPreviewFrame" class="w-full h-full border-0"></iframe>
        </div>
      </div>
      <!-- Floating Run Button (OUTSIDE scrollable area, always visible) -->
      <div class="floating-run-btn" onclick="runCustomCode()" title="Run code (Ctrl+Enter)">
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="12" fill="rgba(0,0,0,0.12)"/>
          <polygon points="9,7 17,12 9,17" fill="currentColor"/>
        </svg>
        <span class="floating-run-btn-tooltip">Run Preview</span>
      </div>
    </div>
  </div>
</body>
</html>
